"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.sandboxMappingTemplate = exports.responseTemplate = exports.requestTemplate = void 0;
const graphql_mapping_template_1 = require("graphql-mapping-template");
const graphql_transformer_common_1 = require("graphql-transformer-common");
const authFilter = graphql_mapping_template_1.ref('ctx.stash.authFilter');
const API_KEY = 'API Key Authorization';
const allowedAggFieldsList = 'allowedAggFields';
function requestTemplate(primaryKey, nonKeywordFields, includeVersion = false, type, keyFields = []) {
    return graphql_mapping_template_1.print(graphql_mapping_template_1.compoundExpression([
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('indexPath'), graphql_mapping_template_1.str(`/${type.toLowerCase()}/doc/_search`)),
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('allowedAggFields'), graphql_mapping_template_1.methodCall(graphql_mapping_template_1.ref('util.defaultIfNull'), graphql_mapping_template_1.ref('ctx.stash.allowedAggFields'), graphql_mapping_template_1.list([]))),
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('aggFieldsFilterMap'), graphql_mapping_template_1.methodCall(graphql_mapping_template_1.ref('util.defaultIfNull'), graphql_mapping_template_1.ref('ctx.stash.aggFieldsFilterMap'), graphql_mapping_template_1.obj({}))),
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('nonKeywordFields'), graphql_mapping_template_1.list(nonKeywordFields)),
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('keyFields'), graphql_mapping_template_1.list(keyFields)),
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortValues'), graphql_mapping_template_1.list([])),
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortFields'), graphql_mapping_template_1.list([])),
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('aggregateValues'), graphql_mapping_template_1.obj({})),
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('primaryKey'), graphql_mapping_template_1.str(primaryKey)),
        graphql_mapping_template_1.iff(graphql_mapping_template_1.not(graphql_mapping_template_1.ref('util.isNullOrEmpty($context.args.sort)')), graphql_mapping_template_1.compoundExpression([
            graphql_mapping_template_1.forEach(graphql_mapping_template_1.ref('sortItem'), graphql_mapping_template_1.ref('context.args.sort'), [
                graphql_mapping_template_1.ifElse(graphql_mapping_template_1.ref('util.isNullOrEmpty($sortItem.field)'), graphql_mapping_template_1.qref('$sortFields.add($primaryKey)'), graphql_mapping_template_1.qref('$sortFields.add($sortItem.field)')),
                graphql_mapping_template_1.ifElse(graphql_mapping_template_1.ref('util.isNullOrEmpty($sortItem.field)'), graphql_mapping_template_1.ifElse(graphql_mapping_template_1.ref('nonKeywordFields.contains($primaryKey)'), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortField'), graphql_mapping_template_1.ref('util.toJson($primaryKey)')), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortField'), graphql_mapping_template_1.ref('util.toJson("${primaryKey}.keyword")'))), graphql_mapping_template_1.ifElse(graphql_mapping_template_1.ref('nonKeywordFields.contains($sortItem.field)'), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortField'), graphql_mapping_template_1.ref('util.toJson($sortItem.field)')), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortField'), graphql_mapping_template_1.ref('util.toJson("${sortItem.field}.keyword")')))),
                graphql_mapping_template_1.ifElse(graphql_mapping_template_1.ref('util.isNullOrEmpty($sortItem.direction)'), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortDirection'), graphql_mapping_template_1.ref('util.toJson({"order": "desc"})')), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortDirection'), graphql_mapping_template_1.ref('util.toJson({"order": $sortItem.direction})'))),
                graphql_mapping_template_1.qref('$sortValues.add("{$sortField: $sortDirection}")'),
            ]),
        ])),
        graphql_mapping_template_1.forEach(graphql_mapping_template_1.ref('keyItem'), graphql_mapping_template_1.ref('keyFields'), [
            graphql_mapping_template_1.iff(graphql_mapping_template_1.not(graphql_mapping_template_1.ref('sortFields.contains($keyItem)')), graphql_mapping_template_1.compoundExpression([
                graphql_mapping_template_1.ifElse(graphql_mapping_template_1.ref('nonKeywordFields.contains($keyItem)'), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortField'), graphql_mapping_template_1.ref('util.toJson($keyItem)')), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortField'), graphql_mapping_template_1.ref('util.toJson("${keyItem}.keyword")'))),
                graphql_mapping_template_1.set(graphql_mapping_template_1.ref('sortDirection'), graphql_mapping_template_1.ref('util.toJson({"order": "desc"})')),
                graphql_mapping_template_1.qref('$sortValues.add("{$sortField: $sortDirection}")'),
            ])),
        ]),
        graphql_mapping_template_1.forEach(graphql_mapping_template_1.ref('aggItem'), graphql_mapping_template_1.ref('context.args.aggregates'), [
            graphql_mapping_template_1.raw('#if( $allowedAggFields.contains($aggItem.field) )\n' +
                '    #set( $aggFilter = { "match_all": {} } )\n' +
                '  #elseif( $aggFieldsFilterMap.containsKey($aggItem.field) )\n' +
                '    #set( $aggFilter = { "bool": { "should": $aggFieldsFilterMap.get($aggItem.field) } } )\n' +
                '  #else\n' +
                '    $util.error("Unauthorized to run aggregation on field: ${aggItem.field}", "Unauthorized")\n' +
                '  #end'),
            graphql_mapping_template_1.ifElse(graphql_mapping_template_1.ref('nonKeywordFields.contains($aggItem.field)'), graphql_mapping_template_1.qref('$aggregateValues.put("$aggItem.name", { "filter": $aggFilter, "aggs": { "$aggItem.name": { "$aggItem.type": { "field": "$aggItem.field" }}} })'), graphql_mapping_template_1.qref('$aggregateValues.put("$aggItem.name", { "filter": $aggFilter, "aggs": { "$aggItem.name": { "$aggItem.type": { "field": "${aggItem.field}.keyword" }}} })')),
        ]),
        graphql_mapping_template_1.ifElse(graphql_mapping_template_1.not(graphql_mapping_template_1.isNullOrEmpty(authFilter)), graphql_mapping_template_1.compoundExpression([
            graphql_mapping_template_1.set(graphql_mapping_template_1.ref('filter'), authFilter),
            graphql_mapping_template_1.iff(graphql_mapping_template_1.not(graphql_mapping_template_1.isNullOrEmpty(graphql_mapping_template_1.ref('ctx.args.filter'))), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('filter'), graphql_mapping_template_1.obj({
                bool: graphql_mapping_template_1.obj({
                    must: graphql_mapping_template_1.list([
                        graphql_mapping_template_1.ref('ctx.stash.authFilter'),
                        graphql_mapping_template_1.ref('util.parseJson($util.transform.toElasticsearchQueryDSL($ctx.args.filter))'),
                    ]),
                }),
            }))),
        ]), graphql_mapping_template_1.iff(graphql_mapping_template_1.not(graphql_mapping_template_1.isNullOrEmpty(graphql_mapping_template_1.ref('ctx.args.filter'))), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('filter'), graphql_mapping_template_1.ref('util.parseJson($util.transform.toElasticsearchQueryDSL($ctx.args.filter))')))),
        graphql_mapping_template_1.iff(graphql_mapping_template_1.isNullOrEmpty(graphql_mapping_template_1.ref('filter')), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('filter'), graphql_mapping_template_1.obj({ match_all: graphql_mapping_template_1.obj({}) }))),
        graphql_mapping_template_1.SearchableMappingTemplate.searchTemplate({
            path: graphql_mapping_template_1.str('$indexPath'),
            size: graphql_mapping_template_1.ifElse(graphql_mapping_template_1.ref('context.args.limit'), graphql_mapping_template_1.ref('context.args.limit'), graphql_mapping_template_1.int(graphql_transformer_common_1.ResourceConstants.DEFAULT_SEARCHABLE_PAGE_LIMIT), true),
            search_after: graphql_mapping_template_1.ref('util.base64Decode($context.args.nextToken)'),
            from: graphql_mapping_template_1.ref('context.args.from'),
            version: graphql_mapping_template_1.bool(includeVersion),
            query: graphql_mapping_template_1.methodCall(graphql_mapping_template_1.ref('util.toJson'), graphql_mapping_template_1.ref('filter')),
            sort: graphql_mapping_template_1.ref('sortValues'),
            aggs: graphql_mapping_template_1.ref('util.toJson($aggregateValues)'),
        }),
    ]));
}
exports.requestTemplate = requestTemplate;
function responseTemplate(includeVersion = false) {
    return graphql_mapping_template_1.print(graphql_mapping_template_1.compoundExpression([
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('es_items'), graphql_mapping_template_1.list([])),
        graphql_mapping_template_1.set(graphql_mapping_template_1.ref('aggregateValues'), graphql_mapping_template_1.list([])),
        graphql_mapping_template_1.forEach(graphql_mapping_template_1.ref('entry'), graphql_mapping_template_1.ref('context.result.hits.hits'), [
            graphql_mapping_template_1.iff(graphql_mapping_template_1.raw('!$foreach.hasNext'), graphql_mapping_template_1.set(graphql_mapping_template_1.ref('nextToken'), graphql_mapping_template_1.ref('util.base64Encode($util.toJson($entry.sort))'))),
            ...getSourceMapper(includeVersion),
        ]),
        graphql_mapping_template_1.forEach(graphql_mapping_template_1.ref('aggItem'), graphql_mapping_template_1.ref('context.result.aggregations.keySet()'), [
            graphql_mapping_template_1.set(graphql_mapping_template_1.ref('aggResult'), graphql_mapping_template_1.obj({})),
            graphql_mapping_template_1.set(graphql_mapping_template_1.ref('aggResultValue'), graphql_mapping_template_1.obj({})),
            graphql_mapping_template_1.set(graphql_mapping_template_1.ref('currentAggItem'), graphql_mapping_template_1.ref('ctx.result.aggregations.get($aggItem)')),
            graphql_mapping_template_1.qref('$aggResult.put("name", $aggItem)'),
            graphql_mapping_template_1.iff(graphql_mapping_template_1.raw('!$util.isNullOrEmpty($currentAggItem)'), graphql_mapping_template_1.compoundExpression([
                graphql_mapping_template_1.iff(graphql_mapping_template_1.raw('!$util.isNullOrEmpty($currentAggItem.get($aggItem).buckets)'), graphql_mapping_template_1.compoundExpression([
                    graphql_mapping_template_1.qref('$aggResultValue.put("__typename", "SearchableAggregateBucketResult")'),
                    graphql_mapping_template_1.qref('$aggResultValue.put("buckets", $currentAggItem.get($aggItem).buckets)'),
                ])),
                graphql_mapping_template_1.iff(graphql_mapping_template_1.raw('!$util.isNullOrEmpty($currentAggItem.get($aggItem).value)'), graphql_mapping_template_1.compoundExpression([
                    graphql_mapping_template_1.qref('$aggResultValue.put("__typename", "SearchableAggregateScalarResult")'),
                    graphql_mapping_template_1.qref('$aggResultValue.put("value", $currentAggItem.get($aggItem).value)'),
                ])),
            ])),
            graphql_mapping_template_1.qref('$aggResult.put("result", $aggResultValue)'),
            graphql_mapping_template_1.qref('$aggregateValues.add($aggResult)'),
        ]),
        graphql_mapping_template_1.toJson(graphql_mapping_template_1.obj({
            items: graphql_mapping_template_1.ref('es_items'),
            total: graphql_mapping_template_1.ref('ctx.result.hits.total.value'),
            nextToken: graphql_mapping_template_1.ref('nextToken'),
            aggregateItems: graphql_mapping_template_1.ref('aggregateValues'),
        })),
    ]));
}
exports.responseTemplate = responseTemplate;
function sandboxMappingTemplate(enabled, fields) {
    let sandboxExp;
    if (enabled) {
        sandboxExp = graphql_mapping_template_1.ifElse(graphql_mapping_template_1.notEquals(graphql_mapping_template_1.methodCall(graphql_mapping_template_1.ref('util.authType')), graphql_mapping_template_1.str(API_KEY)), graphql_mapping_template_1.methodCall(graphql_mapping_template_1.ref('util.unauthorized')), graphql_mapping_template_1.qref(graphql_mapping_template_1.methodCall(graphql_mapping_template_1.ref('ctx.stash.put'), graphql_mapping_template_1.str(allowedAggFieldsList), graphql_mapping_template_1.raw(JSON.stringify(fields)))));
    }
    else {
        sandboxExp = graphql_mapping_template_1.methodCall(graphql_mapping_template_1.ref('util.unauthorized'));
    }
    return graphql_mapping_template_1.printBlock(`Sandbox Mode ${enabled ? 'Enabled' : 'Disabled'}`)(graphql_mapping_template_1.compoundExpression([graphql_mapping_template_1.iff(graphql_mapping_template_1.not(graphql_mapping_template_1.ref('ctx.stash.get("hasAuth")')), sandboxExp), graphql_mapping_template_1.toJson(graphql_mapping_template_1.obj({}))]));
}
exports.sandboxMappingTemplate = sandboxMappingTemplate;
function getSourceMapper(includeVersion) {
    if (includeVersion) {
        return [
            graphql_mapping_template_1.set(graphql_mapping_template_1.ref('row'), graphql_mapping_template_1.methodCall(graphql_mapping_template_1.ref('entry.get'), graphql_mapping_template_1.str('_source'))),
            graphql_mapping_template_1.qref('$row.put("_version", $entry.get("_version"))'),
            graphql_mapping_template_1.qref('$es_items.add($row)'),
        ];
    }
    return [graphql_mapping_template_1.qref('$es_items.add($entry.get("_source"))')];
}
//# sourceMappingURL=generate-resolver-vtl.js.map